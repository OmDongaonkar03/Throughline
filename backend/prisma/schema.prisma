generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  name                 String
  bio                  String?
  password             String?
  passwordHistory      Json?                 // Stores last 5 password hashes
  googleId             String?               @unique
  profilePhoto         String?
  verified             Boolean               @default(false)
  hasCompletedOnboarding Boolean             @default(false)
  
  // Brute force protection
  loginAttempts        Int                   @default(0)
  lockedUntil          DateTime?
  
  refreshTokens        RefreshToken[]
  notificationSettings NotificationSettings?
  verificationTokens   VerificationToken[]
  passwordResetTokens  PasswordResetToken[]
  checkIns             CheckIn[]
  samplePosts          SamplePost[]
  generatedPosts       GeneratedPost[]
  toneProfile          ToneProfile?
  generationSchedule   GenerationSchedule?
  generationJobs       GenerationJob[]
  postFeedback         PostFeedback[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  
  @@index([email])
  @@index([googleId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model VerificationToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([tokenHash])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([tokenHash])
}

model CheckIn {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model NotificationSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailDigest   Boolean  @default(true)
  postReminders Boolean  @default(true)
  weeklyReport  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model SamplePost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model GeneratedPost {
  id             String          @id @default(cuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type           PostType
  date           DateTime        // The date this post represents
  
  content        String          @db.Text // Base narrative
  metadata       Json?           // Structured insights
  
  toneProfileId  String?
  toneProfile    ToneProfile?    @relation(fields: [toneProfileId], references: [id])
  
  version        Int             @default(1)
  isLatest       Boolean         @default(true)
  generationType GenerationType  @default(AUTO)
  
  modelUsed      String?         // e.g., "openai/gpt-4o-mini"
  
  // Token usage tracking
  tokenUsage     TokenUsage[]
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  @@index([userId, date, type])
  @@index([userId, type, isLatest])
  @@index([date])
}

model TokenUsage {
  id                String   @id @default(cuid())
  
  // Links to GeneratedPost only (platform posts removed)
  generatedPostId   String
  generatedPost     GeneratedPost @relation(fields: [generatedPostId], references: [id], onDelete: Cascade)
  
  // Token counts
  promptTokens      Int
  completionTokens  Int
  totalTokens       Int
  
  // Cost tracking
  modelUsed         String
  estimatedCost     Float?
  
  // Context - identifies which agent was used
  agentType         String  // "daily-generator", "weekly-generator", "monthly-generator", "tone-extractor"
  
  // Timestamps
  createdAt         DateTime @default(now())
  
  @@index([generatedPostId])
  @@index([agentType])
  @@index([createdAt])
}

enum PostType {
  DAILY
  WEEKLY
  MONTHLY
}

enum GenerationType {
  AUTO
  MANUAL
}

model ToneProfile {
  id             String          @id @default(cuid())
  userId         String          @unique
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // AI-extracted tone characteristics (from sample posts)
  voice          String          @db.Text
  sentenceStyle  String          @db.Text
  emotionalRange String          @db.Text
  commonPhrases  Json?
  exampleText    String          @db.Text
  fullProfile    Json
  
  extractedAt    DateTime        @default(now())
  modelUsed      String
  
  // Manual customization fields
  customVoice         String?         @db.Text     // User's manual override for voice
  customSentenceStyle String?         @db.Text     // User's manual override for sentence style
  customEmotionalRange String?        @db.Text     // User's manual override for emotional range
  
  // New user-defined fields
  writingGoals        Json?           // Array of goals: ["educate", "inspire", "entertain", "inform"]
  targetAudience      Json?           // Array: ["professionals", "students", "general_public", "entrepreneurs"]
  contentPurpose      String?         @db.Text     // What they want to achieve
  toneCharacteristics Json?           // Custom characteristics: {formality: 7, enthusiasm: 5, humor: 3}
  avoidTopics         Json?           // Topics to avoid
  preferredLength     String?         // "concise", "moderate", "detailed"
  includeEmojis       Boolean         @default(false)
  includeHashtags     Boolean         @default(true)
  
  manuallyEdited      Boolean         @default(false)
  lastManualEdit      DateTime?
  
  posts          GeneratedPost[]
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  @@index([userId])
}

model GenerationSchedule {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dailyEnabled   Boolean  @default(true)
  dailyTime      String   @default("21:00")
  
  weeklyEnabled  Boolean  @default(true)
  weeklyDay      Int      @default(0)
  weeklyTime     String   @default("20:00")
  
  monthlyEnabled Boolean  @default(true)
  monthlyDay     Int      @default(28)
  monthlyTime    String   @default("20:00")
  
  timezone       String   @default("Asia/Kolkata")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([userId])
}

model GenerationJob {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        PostType
  date        DateTime
  
  status      JobStatus @default(PENDING)
  error       String?   @db.Text
  
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([userId, status])
  @@index([status, createdAt])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PostFeedback {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  
  rating    Int      // 1 = thumbs down, 2 = thumbs up
  issue     String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([postId])
  @@index([userId, postId])
}